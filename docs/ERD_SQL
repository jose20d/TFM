-- This script was generated by the ERD tool in pgAdmin 4.
-- Please log an issue at https://github.com/pgadmin-org/pgadmin4/issues/new/choose if you find any bugs, including reproduction steps.
BEGIN;


CREATE TABLE IF NOT EXISTS public.country_indicator
(
    indicator_id serial NOT NULL,
    country_id integer,
    dataset_id text COLLATE pg_catalog."default",
    indicator_code text COLLATE pg_catalog."default",
    year integer NOT NULL,
    value numeric,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT country_indicator_pkey PRIMARY KEY (indicator_id),
    CONSTRAINT country_indicator_unique_idx UNIQUE (country_id, dataset_id, indicator_code, year)
);

CREATE TABLE IF NOT EXISTS public.dataset_config
(
    dataset_id text COLLATE pg_catalog."default" NOT NULL,
    source_name text COLLATE pg_catalog."default" NOT NULL,
    source_url text COLLATE pg_catalog."default" NOT NULL,
    format text COLLATE pg_catalog."default" NOT NULL,
    update_frequency text COLLATE pg_catalog."default",
    is_active boolean DEFAULT true,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT dataset_config_pkey PRIMARY KEY (dataset_id)
);

CREATE TABLE IF NOT EXISTS public.dim_country
(
    country_id serial NOT NULL,
    country_name text COLLATE pg_catalog."default" NOT NULL,
    country_norm text COLLATE pg_catalog."default" NOT NULL,
    iso3 character(3) COLLATE pg_catalog."default",
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT dim_country_pkey PRIMARY KEY (country_id),
    CONSTRAINT dim_country_country_norm_key UNIQUE (country_norm)
);

CREATE TABLE IF NOT EXISTS public.etl_dataset_run_log
(
    id bigserial NOT NULL,
    dataset_id text COLLATE pg_catalog."default",
    executed_at timestamp without time zone DEFAULT now(),
    download_success boolean,
    hash_value text COLLATE pg_catalog."default",
    has_changes boolean,
    load_success boolean,
    rows_inserted integer,
    rows_updated integer,
    duration_ms integer,
    error_message text COLLATE pg_catalog."default",
    CONSTRAINT etl_dataset_run_log_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.etl_dataset_state
(
    dataset_id text COLLATE pg_catalog."default" NOT NULL,
    last_hash text COLLATE pg_catalog."default",
    last_loaded_at timestamp without time zone,
    last_success boolean,
    CONSTRAINT etl_dataset_state_pkey PRIMARY KEY (dataset_id)
);

CREATE TABLE IF NOT EXISTS public.etl_load_log
(
    load_id serial NOT NULL,
    dataset_id text COLLATE pg_catalog."default",
    raw_filename text COLLATE pg_catalog."default" NOT NULL,
    file_hash text COLLATE pg_catalog."default",
    file_size_bytes bigint,
    rows_inserted integer,
    rows_failed integer,
    load_status text COLLATE pg_catalog."default",
    error_message text COLLATE pg_catalog."default",
    load_timestamp timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT etl_load_log_pkey PRIMARY KEY (load_id)
);

CREATE TABLE IF NOT EXISTS public.iso_country_codes
(
    iso_id serial NOT NULL,
    country_name text COLLATE pg_catalog."default" NOT NULL,
    country_norm text COLLATE pg_catalog."default" NOT NULL,
    iso2 character(2) COLLATE pg_catalog."default",
    iso3 character(3) COLLATE pg_catalog."default",
    iso_numeric text COLLATE pg_catalog."default",
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT iso_country_codes_pkey PRIMARY KEY (iso_id),
    CONSTRAINT iso_country_codes_iso3_unique UNIQUE (iso3)
);

CREATE TABLE IF NOT EXISTS public.mrds_ages
(
    age_id serial NOT NULL,
    dep_id bigint,
    age_tp text COLLATE pg_catalog."default",
    age_young text COLLATE pg_catalog."default",
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT mrds_ages_pkey PRIMARY KEY (age_id)
);

CREATE TABLE IF NOT EXISTS public.mrds_commodity
(
    commodity_id serial NOT NULL,
    dep_id bigint,
    commod text COLLATE pg_catalog."default",
    code text COLLATE pg_catalog."default",
    commod_tp text COLLATE pg_catalog."default",
    commod_group text COLLATE pg_catalog."default",
    import text COLLATE pg_catalog."default",
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT mrds_commodity_pkey PRIMARY KEY (commodity_id)
);

CREATE TABLE IF NOT EXISTS public.mrds_deposit
(
    dep_id bigint NOT NULL,
    name text COLLATE pg_catalog."default",
    dev_stat text COLLATE pg_catalog."default",
    code_list text COLLATE pg_catalog."default",
    latitude numeric(9, 6),
    longitude numeric(9, 6),
    geom geometry(Point,4326),
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT mrds_deposit_pkey PRIMARY KEY (dep_id)
);

CREATE TABLE IF NOT EXISTS public.mrds_location
(
    dep_id bigint NOT NULL,
    country_id integer,
    state_prov text COLLATE pg_catalog."default",
    region text COLLATE pg_catalog."default",
    county text COLLATE pg_catalog."default",
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT mrds_location_pkey PRIMARY KEY (dep_id)
);

CREATE TABLE IF NOT EXISTS public.mrds_material
(
    material_id serial NOT NULL,
    dep_id bigint,
    rec text COLLATE pg_catalog."default",
    ore_gangue text COLLATE pg_catalog."default",
    material text COLLATE pg_catalog."default",
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT mrds_material_pkey PRIMARY KEY (material_id)
);

CREATE TABLE IF NOT EXISTS public.mrds_ownership
(
    ownership_id serial NOT NULL,
    dep_id bigint,
    owner_name text COLLATE pg_catalog."default",
    owner_tp text COLLATE pg_catalog."default",
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT mrds_ownership_pkey PRIMARY KEY (ownership_id)
);

CREATE TABLE IF NOT EXISTS public.mrds_physiography
(
    physiography_id serial NOT NULL,
    dep_id bigint,
    phys_div text COLLATE pg_catalog."default",
    phys_prov text COLLATE pg_catalog."default",
    phys_sect text COLLATE pg_catalog."default",
    phys_det text COLLATE pg_catalog."default",
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT mrds_physiography_pkey PRIMARY KEY (physiography_id)
);

CREATE TABLE IF NOT EXISTS public.mrds_rocks
(
    rock_id serial NOT NULL,
    dep_id bigint,
    rock_cls text COLLATE pg_catalog."default",
    first_ord_nm text COLLATE pg_catalog."default",
    second_ord_nm text COLLATE pg_catalog."default",
    third_ord_nm text COLLATE pg_catalog."default",
    low_name text COLLATE pg_catalog."default",
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT mrds_rocks_pkey PRIMARY KEY (rock_id)
);

ALTER TABLE IF EXISTS public.country_indicator
    ADD CONSTRAINT country_indicator_country_id_fkey FOREIGN KEY (country_id)
    REFERENCES public.dim_country (country_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.country_indicator
    ADD CONSTRAINT country_indicator_dataset_id_fkey FOREIGN KEY (dataset_id)
    REFERENCES public.dataset_config (dataset_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.etl_load_log
    ADD CONSTRAINT etl_load_log_dataset_id_fkey FOREIGN KEY (dataset_id)
    REFERENCES public.dataset_config (dataset_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.mrds_ages
    ADD CONSTRAINT mrds_ages_dep_id_fkey FOREIGN KEY (dep_id)
    REFERENCES public.mrds_deposit (dep_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_mrds_ages_dep
    ON public.mrds_ages(dep_id);


ALTER TABLE IF EXISTS public.mrds_commodity
    ADD CONSTRAINT mrds_commodity_dep_id_fkey FOREIGN KEY (dep_id)
    REFERENCES public.mrds_deposit (dep_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_mrds_commodity_dep
    ON public.mrds_commodity(dep_id);


ALTER TABLE IF EXISTS public.mrds_location
    ADD CONSTRAINT mrds_location_country_id_fkey FOREIGN KEY (country_id)
    REFERENCES public.dim_country (country_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_mrds_location_country
    ON public.mrds_location(country_id);


ALTER TABLE IF EXISTS public.mrds_location
    ADD CONSTRAINT mrds_location_dep_id_fkey FOREIGN KEY (dep_id)
    REFERENCES public.mrds_deposit (dep_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS mrds_location_pkey
    ON public.mrds_location(dep_id);


ALTER TABLE IF EXISTS public.mrds_material
    ADD CONSTRAINT mrds_material_dep_id_fkey FOREIGN KEY (dep_id)
    REFERENCES public.mrds_deposit (dep_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_mrds_material_dep
    ON public.mrds_material(dep_id);


ALTER TABLE IF EXISTS public.mrds_ownership
    ADD CONSTRAINT mrds_ownership_dep_id_fkey FOREIGN KEY (dep_id)
    REFERENCES public.mrds_deposit (dep_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_mrds_ownership_dep
    ON public.mrds_ownership(dep_id);


ALTER TABLE IF EXISTS public.mrds_physiography
    ADD CONSTRAINT mrds_physiography_dep_id_fkey FOREIGN KEY (dep_id)
    REFERENCES public.mrds_deposit (dep_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_mrds_physiography_dep
    ON public.mrds_physiography(dep_id);


ALTER TABLE IF EXISTS public.mrds_rocks
    ADD CONSTRAINT mrds_rocks_dep_id_fkey FOREIGN KEY (dep_id)
    REFERENCES public.mrds_deposit (dep_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_mrds_rocks_dep
    ON public.mrds_rocks(dep_id);

END;